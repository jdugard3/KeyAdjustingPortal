<%- include('partials/header') %>

<div class="container">
  <div class="claim-detail">
    <div class="claim-detail-header">
      <div class="header-top">
        <div class="navigation-buttons">
          <a href="/dashboard" class="btn btn-link">
            <i class="fas fa-arrow-left"></i> Back to Claims
          </a>
          <a href="/dashboard" class="btn btn-home">
            <i class="fas fa-home"></i> Home
          </a>
        </div>
        <div class="claim-status-badge" style="background-color: <%= claim.status.color || '#999999' %>">
          <%= (claim.status.status || 'Unknown').toUpperCase() %>
        </div>
      </div>
      <h1 class="claim-title"><%= claim.name %></h1>
    </div>

    <div class="claim-detail-content">
      <!-- Group 1: Key Information -->
      <div class="detail-section collapsible">
        <div class="section-header" onclick="toggleSection(this)">
          <h3><i class="fas fa-info-circle"></i> Key Information</h3>
          <i class="fas fa-chevron-down toggle-icon"></i>
        </div>
        <div class="section-content" style="display: none;">
          <div class="info-grid">
            <% const keyFields = claim.customFields.filter(field => 
              ['Policy Holder', 'Insurance Carrier', 'Claim Number', 'Date of Loss'].includes(field.name)
            );
            keyFields.forEach(field => { %>
              <div class="info-item">
                <label><%= field.name %></label>
                <span><%= field.value %></span>
              </div>
            <% }); %>
          </div>
        </div>
      </div>

      <!-- Group 3: Location Information -->
      <div class="detail-section collapsible">
        <div class="section-header" onclick="toggleSection(this)">
          <h3><i class="fas fa-map-marker-alt"></i> Location Details</h3>
          <i class="fas fa-chevron-down toggle-icon"></i>
        </div>
        <div class="section-content" style="display: none;">
          <% 
          const locationFields = claim.customFields.filter(field => 
            ['Property Address', 'Loss Address', 'Property Type'].includes(field.name)
          );
          locationFields.forEach(field => { %>
            <div class="info-item">
              <label><%= field.name %></label>
              <span><%= field.value %></span>
            </div>
          <% }); %>
        </div>
      </div>

      <!-- Group 4: Contact Information -->
      <div class="detail-section collapsible">
        <div class="section-header" onclick="toggleSection(this)">
          <h3><i class="fas fa-address-book"></i> Contact Information</h3>
          <i class="fas fa-chevron-down toggle-icon"></i>
        </div>
        <div class="section-content" style="display: none;">
          <% 
          const contactFields = claim.customFields.filter(field => 
            ['Phone Number', 'Email', 'Contractor Salesman', 'Key PA'].includes(field.name)
          );
          contactFields.forEach(field => { %>
            <div class="info-item">
              <label><%= field.name %></label>
              <span><%= field.value %></span>
            </div>
          <% }); %>
        </div>
      </div>

      <!-- Group 5: Documents -->
      <div class="detail-section collapsible">
        <div class="section-header" onclick="toggleSection(this)">
          <h3><i class="fas fa-file-alt"></i> Documents</h3>
          <i class="fas fa-chevron-down toggle-icon"></i>
        </div>
        <div class="section-content" style="display: none;">
          <!-- Upload Form -->
          <div class="upload-section">
            <form action="/dashboard/upload/<%= claim.id %>" method="POST" enctype="multipart/form-data" class="upload-form">
              <div class="form-group">
                <label for="fileType">Document Type</label>
                <select name="fileType" id="fileType" class="form-control" required>
                  <option value="">Select document type...</option>
                  <option value="Loss Sheet">Loss Sheet</option>
                  <option value="Check">Check</option>
                  <option value="Contract">Contract</option>
                  <option value="Other">Other</option>
                </select>
                <div id="otherTypeContainer" style="display: none;">
                  <input type="text" name="otherType" id="otherType" class="form-control" 
                    placeholder="Please specify document type">
                </div>
              </div>
              
              <div class="file-upload-container">
                <input type="file" name="document" id="document" class="file-input" required>
                <label for="document" class="file-label">
                  <i class="fas fa-cloud-upload-alt"></i>
                  <span>Choose a file</span>
                </label>
                <span class="selected-file-name"></span>
              </div>
              <button type="submit" class="btn btn-upload">
                <i class="fas fa-upload"></i> Upload Document
              </button>
            </form>
          </div>

          <!-- Existing Documents -->
          <% if (claim.attachments && claim.attachments.length > 0) { %>
            <div class="documents-grid">
              <% claim.attachments.forEach(attachment => { %>
                <a href="<%= attachment.url %>" class="document-card" target="_blank">
                  <div class="document-icon">
                    <i class="fas <%= getFileIcon(attachment.title) %>"></i>
                  </div>
                  <div class="document-info">
                    <span class="document-name"><%= attachment.title %></span>
                    <span class="document-date">
                      <%= new Date(attachment.date).toLocaleDateString() %>
                    </span>
                  </div>
                </a>
              <% }); %>
            </div>
          <% } %>
        </div>
      </div>

      <!-- Group 6: Additional Information -->
      <div class="detail-section collapsible">
        <div class="section-header" onclick="toggleSection(this)">
          <h3><i class="fas fa-info-circle"></i> Additional Information</h3>
          <i class="fas fa-chevron-down toggle-icon"></i>
        </div>
        <div class="section-content" style="display: none;">
          <% 
          // List of field names that should be displayed (with emoji prefixes)
          const allowedFieldNames = [
            '📋 Claim Number',
            'Substage',
            '✏ ️ Cause of Loss',
            '💰 ACV',
            '💰 Deductible',
            '📋 Policy Number',
            '🗓 ️ Date Of Loss',
            '🗓 ️ Date Created',
            '🗓 ️ Date Closed',
            '📅 Date Approved',
            '⭕ PA Email',
            '💰 Recoverable Depreciation',
            '💰 Non Rec Depreciation',
            '💰 PWI',
            '💰 PPS',
            '🗓️ Claim Filed Date',
            '💰RCV'  // No space between emoji and RCV
          ];
          
          // Add additional variations of field names that might exist
          const additionalVariations = [
            '$ 💰 RCV',
            '$ 💰RCV',
            '$  💰 RCV',
            '💰 RCV'  // With space between emoji and RCV
          ];
          
          const allAllowedNames = [...allowedFieldNames, ...additionalVariations];
          
          // Filter custom fields to only show those with names in the allowed list
          const additionalFields = claim.customFields.filter(field => 
            allAllowedNames.includes(field.name)
          );
          
          if (additionalFields.length > 0) { %>
            <div class="info-grid">
              <% additionalFields.forEach(field => { 
                let displayValue = field.value;
                
                // Format date fields if they contain timestamp values
                if (field.name.includes('Date') && !isNaN(field.value) && field.value > 1000000000) {
                  try {
                    const date = new Date(parseInt(field.value));
                    displayValue = date.toLocaleDateString();
                  } catch (e) {
                    // Keep original value if date parsing fails
                  }
                }
                
                // Format currency fields
                if ((field.name.includes('ACV') || field.name.includes('RCV') || 
                     field.name.includes('Deductible') || field.name.includes('Depreciation') ||
                     field.name.includes('PWI') || field.name.includes('PPS')) && 
                    !isNaN(field.value)) {
                  try {
                    displayValue = parseFloat(field.value).toLocaleString('en-US', {
                      style: 'currency',
                      currency: 'USD'
                    });
                  } catch (e) {
                    // Keep original value if formatting fails
                  }
                }
              %>
                <div class="info-item">
                  <label><%= field.name %></label>
                  <span><%= displayValue %></span>
                </div>
              <% }); %>
            </div>
          <% } else { %>
            <div class="info-item">
              <p>No additional information available.</p>
            </div>
          <% } %>
        </div>
      </div>

      <!-- Group 7: Comments & Activity -->
      <div class="detail-section collapsible">
        <div class="section-header" onclick="toggleSection(this)">
          <h3><i class="fas fa-comments"></i> Comments & Activity</h3>
          <i class="fas fa-chevron-down toggle-icon"></i>
        </div>
        <div class="section-content" style="display: none;">
          <!-- Comments List -->
          <div class="comments-section">
            <h4>Recent Activity</h4>
            <div class="comments-list" id="comments-list">
              <% if (claim.comments && claim.comments.length > 0) { %>
                <% claim.comments.forEach(comment => { %>
                  <div class="comment-item">
                    <div class="comment-header">
                      <span class="comment-author"><%= comment.user ? comment.user.username : 'User' %></span>
                      <span class="comment-date"><%= new Date(parseInt(comment.date)).toLocaleString() %></span>
                    </div>
                    <div class="comment-body">
                      <%= comment.comment_text || (comment.comment && comment.comment[0] && comment.comment[0].text) || 'No text' %>
                    </div>
                  </div>
                <% }); %>
              <% } else { %>
                <div class="no-comments-message">
                  No comments yet.
                </div>
              <% } %>
            </div>
          </div>
          
          <!-- Add Comment Form -->
          <div class="add-comment-section">
            <h4>Add Comment</h4>
            <form id="comment-form" class="comment-form">
              <div class="form-group">
                <textarea 
                  name="comment_text" 
                  id="comment_text" 
                  class="form-control" 
                  rows="3" 
                  placeholder="Type your comment here..."
                  required
                ></textarea>
              </div>
              <div class="form-group">
                <div class="form-check">
                  <input type="checkbox" class="form-check-input" id="notify_all" name="notify_all" checked>
                  <label class="form-check-label" for="notify_all">Notify all team members</label>
                </div>
              </div>
              <input type="hidden" name="claimId" value="<%= claim.id %>">
              <button type="submit" class="btn btn-primary">
                <i class="fas fa-paper-plane"></i> Post Comment
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
.info-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 1.5rem;
  margin-top: 1rem;
}

.info-item {
  background: var(--card-bg);
  padding: 1rem;
  border-radius: var(--border-radius);
  box-shadow: var(--box-shadow);
}

.info-item label {
  display: block;
  color: var(--primary-color);
  font-weight: 500;
  margin-bottom: 0.5rem;
  font-size: 0.9rem;
}

.info-item span {
  display: block;
  font-size: 1.1rem;
  color: var(--text-color);
  word-break: break-word;
}

.detail-section {
  background: white;
  padding: 1.5rem;
  border-radius: var(--border-radius);
  margin-bottom: 1.5rem;
  box-shadow: var(--box-shadow);
}

.detail-section h3 {
  color: var(--primary-color);
  display: flex;
  align-items: center;
  gap: 0.5rem;
  margin-bottom: 1rem;
  padding-bottom: 0.5rem;
  border-bottom: 2px solid var(--background-color);
}

.detail-section h3 i {
  color: var(--secondary-color);
}

.section-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  cursor: pointer;
  padding: 1rem 0;
}

.section-header h3 {
  margin: 0;
}

.toggle-icon {
  transition: transform 0.3s ease;
  color: var(--primary-color);
}

.detail-section.expanded .toggle-icon {
  transform: rotate(180deg);
}

.section-content {
  transition: all 0.3s ease;
  overflow: hidden;
}

.detail-section {
  margin-bottom: 1rem;
}

.detail-section:not(:last-child) {
  border-bottom: 1px solid rgba(0, 0, 0, 0.1);
}

/* Comments styles */
.comments-section {
  margin-bottom: 2rem;
}

.comments-list {
  max-height: 400px;
  overflow-y: auto;
  border: 1px solid #e0e0e0;
  border-radius: 4px;
  padding: 1rem;
  background-color: #f9f9f9;
}

.comment-item {
  padding: 1rem;
  border-bottom: 1px solid #e0e0e0;
  margin-bottom: 1rem;
  background-color: white;
  border-radius: 4px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.comment-item:last-child {
  margin-bottom: 0;
  border-bottom: none;
}

.comment-header {
  display: flex;
  justify-content: space-between;
  margin-bottom: 0.5rem;
  font-size: 0.9rem;
}

.comment-author {
  font-weight: bold;
  color: var(--primary-color);
}

.comment-date {
  color: #777;
}

.comment-body {
  white-space: pre-wrap;
  word-break: break-word;
}

.add-comment-section {
  margin-top: 1rem;
}

.comment-form textarea {
  resize: vertical;
  min-height: 80px;
}

.no-comments-message {
  padding: 1rem;
  color: #777;
  text-align: center;
  font-style: italic;
}
</style>

<script>
function getFileIcon(filename) {
  const ext = filename.split('.').pop().toLowerCase();
  const icons = {
    pdf: 'fa-file-pdf',
    doc: 'fa-file-word',
    docx: 'fa-file-word',
    xls: 'fa-file-excel',
    xlsx: 'fa-file-excel',
    jpg: 'fa-file-image',
    jpeg: 'fa-file-image',
    png: 'fa-file-image',
    txt: 'fa-file-alt',
    csv: 'fa-file-csv'
  };
  return icons[ext] || 'fa-file';
}

document.querySelector('.file-input').addEventListener('change', function(e) {
  const fileName = e.target.files[0]?.name || 'No file selected';
  document.querySelector('.selected-file-name').textContent = fileName;
});

document.getElementById('fileType').addEventListener('change', function() {
  const otherContainer = document.getElementById('otherTypeContainer');
  const otherInput = document.getElementById('otherType');
  
  if (this.value === 'Other') {
    otherContainer.style.display = 'block';
    otherInput.required = true;
  } else {
    otherContainer.style.display = 'none';
    otherInput.required = false;
    otherInput.value = '';
  }
});

function toggleSection(header) {
  const section = header.closest('.detail-section');
  const content = section.querySelector('.section-content');
  const isExpanded = section.classList.contains('expanded');
  
  // Close all sections first
  document.querySelectorAll('.detail-section').forEach(s => {
    if (s !== section) {
      s.classList.remove('expanded');
      s.querySelector('.section-content').style.display = 'none';
    }
  });
  
  // Toggle clicked section
  if (isExpanded) {
    section.classList.remove('expanded');
    content.style.display = 'none';
  } else {
    section.classList.add('expanded');
    content.style.display = 'block';
  }
}

// Optional: Expand first section by default
document.addEventListener('DOMContentLoaded', function() {
  const firstSection = document.querySelector('.detail-section');
  if (firstSection) {
    firstSection.classList.add('expanded');
    firstSection.querySelector('.section-content').style.display = 'block';
  }
});

// Comment form submission
document.getElementById('comment-form').addEventListener('submit', async function(e) {
  e.preventDefault();
  
  const commentText = document.getElementById('comment_text').value;
  const notifyAll = document.getElementById('notify_all').checked;
  const claimId = this.elements.claimId.value;
  
  if (!commentText.trim()) {
    alert('Please enter a comment');
    return;
  }
  
  // Disable the submit button and show loading state
  const submitBtn = this.querySelector('button[type="submit"]');
  const originalBtnText = submitBtn.innerHTML;
  submitBtn.disabled = true;
  submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Posting...';
  
  try {
    const response = await fetch(`/claims/${claimId}/comment`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        comment_text: commentText,
        notify_all: notifyAll
      })
    });
    
    const responseData = await response.json();
    
    if (!response.ok) {
      throw new Error(responseData.error || 'Failed to post comment');
    }
    
    // Add the new comment to the list
    const commentsList = document.getElementById('comments-list');
    const noCommentsMsg = commentsList.querySelector('.no-comments-message');
    if (noCommentsMsg) {
      noCommentsMsg.remove();
    }
    
    const newComment = document.createElement('div');
    newComment.className = 'comment-item';
    newComment.innerHTML = `
      <div class="comment-header">
        <span class="comment-author">${responseData.user?.username || 'You'}</span>
        <span class="comment-date">${new Date().toLocaleString()}</span>
      </div>
      <div class="comment-body">
        ${responseData.comment_text || commentText}
      </div>
    `;
    
    commentsList.insertBefore(newComment, commentsList.firstChild);
    
    // Clear the form
    document.getElementById('comment_text').value = '';
    
  } catch (error) {
    console.error('Error posting comment:', error);
    alert(`Failed to post comment: ${error.message}`);
  } finally {
    // Re-enable the submit button
    submitBtn.disabled = false;
    submitBtn.innerHTML = originalBtnText;
  }
});
</script>

<%- include('partials/footer') %> 